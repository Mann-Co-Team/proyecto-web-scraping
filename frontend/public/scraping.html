<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Arriendos Talca - Resultados de Scraping</title>
    <style>
      :root {
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: #0f172a;
        background-color: #f8fafc;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
        background: #f8fafc;
        color: #0f172a;
      }

      .page {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      nav {
        width: 100%;
        background: #fff;
        border-bottom: 1px solid #e2e8f0;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .nav-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0.75rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      .brand {
        display: flex;
        flex-direction: column;
        line-height: 1.1;
      }

      .brand span:first-child {
        font-weight: 700;
        color: #1d4ed8;
        font-size: 1.2rem;
      }

      .brand span:last-child {
        font-size: 0.85rem;
        color: #64748b;
      }

      .nav-links {
        display: flex;
        gap: 0.75rem;
        align-items: center;
      }

      .nav-links a {
        text-decoration: none;
        color: #0f172a;
        font-weight: 500;
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
      }

      .nav-links a.active {
        background: #e0e7ff;
        color: #4338ca;
      }

      .nav-links button {
        border-radius: 999px;
        border: 1px solid #d5dbe7;
        background: #fff;
        padding: 0.4rem 1rem;
        font-weight: 600;
        cursor: pointer;
      }

      .nav-links button.primary {
        background: #0f766e;
        color: #fff;
        border-color: #0f766e;
      }

      .auth-indicator {
        font-size: 0.85rem;
        color: #475569;
        background: #e2e8f0;
        padding: 0.3rem 0.75rem;
        border-radius: 999px;
      }

      .hero {
        background: linear-gradient(180deg, #f1f5f9 0%, #fff 55%);
        padding: 3rem 1.5rem 2rem;
      }

      .hero-content {
        max-width: 1050px;
        margin: 0 auto;
        text-align: center;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .hero h1 {
        margin: 0;
        font-size: clamp(2rem, 3vw, 2.8rem);
        color: #0f172a;
      }

      .hero p {
        margin: 0;
        color: #475569;
        font-size: 1.1rem;
      }

      .filters-card {
        margin: 1.5rem auto 0;
        background: #fff;
        border-radius: 20px;
        padding: 1.75rem;
        box-shadow: 0 30px 70px rgba(15, 23, 42, 0.08);
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        align-items: end;
        max-width: 900px;
      }

      .pill-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.75rem;
        margin-bottom: 0.5rem;
      }

      .pill {
        border-radius: 14px;
        border: 1px solid #e2e8f0;
        background: #f8fafc;
        padding: 0.7rem 1rem;
        display: flex;
        flex-direction: column;
        text-align: left;
      }

      .pill span:first-child {
        font-size: 0.8rem;
        color: #94a3b8;
      }

      .pill span:last-child {
        font-weight: 600;
        color: #0f172a;
      }

      label {
        display: flex;
        flex-direction: column;
        gap: 0.45rem;
        font-size: 0.92rem;
        color: #475569;
        text-align: left;
      }

      input,
      select {
        border: 1px solid #cbd5f5;
        border-radius: 12px;
        padding: 0.7rem 0.9rem;
        font-size: 1rem;
        background: #f8fafc;
        color: #0f172a;
      }

      .filters-card button {
        border: none;
        border-radius: 12px;
        padding: 0.95rem 1.25rem;
        font-size: 1rem;
        font-weight: 600;
        background: #0f766e;
        color: #fff;
        cursor: pointer;
        box-shadow: 0 12px 30px rgba(15, 118, 110, 0.25);
      }

      main {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1.5rem 3rem;
        flex: 1;
        width: 100%;
      }

      #status {
        margin: 0 0 0.5rem;
        padding: 0.75rem 1.25rem;
        border-radius: 12px;
        background: #e0f2fe;
        border: 1px solid #bae6fd;
        color: #075985;
        min-height: 3rem;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
      }

      #warnings {
        margin: 0 0 1rem;
        padding-left: 1.25rem;
        color: #b45309;
      }

      .section-heading {
        margin: 2.5rem 0 1rem;
        font-size: 1.75rem;
        color: #0f172a;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.75rem;
      }

      .card {
        border-radius: 24px;
        overflow: hidden;
        border: 1px solid #e2e8f0;
        background: #fff;
        box-shadow: 0 18px 45px rgba(15, 23, 42, 0.08);
        display: flex;
        flex-direction: column;
        min-height: 420px;
      }

      .card img {
        width: 100%;
        height: 210px;
        object-fit: cover;
      }

      .card-body {
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.65rem;
        flex: 1;
      }

      .card h3 {
        margin: 0;
        font-size: 1.2rem;
        color: #0f172a;
      }

      .price {
        font-size: 1.2rem;
        color: #0369a1;
        font-weight: 700;
      }

      .meta {
        font-size: 0.95rem;
        color: #475569;
        display: flex;
        gap: 0.4rem;
        align-items: center;
      }

      .meta span {
        display: inline-flex;
        align-items: center;
        gap: 0.2rem;
      }

      .card a {
        margin-top: auto;
        color: #0f766e;
        text-decoration: none;
        font-weight: 600;
      }

      .empty-state {
        grid-column: 1 / -1;
        text-align: center;
        padding: 4rem 2rem;
        border-radius: 24px;
        background: #f1f5f9;
        border: 1px dashed #cbd5f5;
        color: #475569;
      }

      footer {
        border-top: 1px solid #e2e8f0;
        background: #fff;
        text-align: center;
        padding: 1.5rem 1rem;
        color: #64748b;
        font-size: 0.95rem;
      }

      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        backdrop-filter: blur(2px);
        display: none;
        z-index: 50;
      }

      .modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 60;
        padding: 1rem;
      }

      .modal-content {
        width: min(420px, 100%);
        background: #fff;
        border-radius: 24px;
        padding: 2rem;
        box-shadow: 0 30px 70px rgba(15, 23, 42, 0.2);
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .modal-content h3 {
        margin: 0;
        font-size: 1.5rem;
        color: #0f172a;
      }

      .modal-content p {
        margin: 0;
        color: #475569;
        font-size: 0.95rem;
      }

      .modal-content form {
        display: flex;
        flex-direction: column;
        gap: 0.85rem;
      }

      .modal-content input {
        width: 100%;
      }

      .modal-content button[type='submit'] {
        border: none;
        border-radius: 12px;
        padding: 0.85rem 1rem;
        background: #2563eb;
        color: #fff;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
      }

      .modal-content .secondary {
        background: transparent;
        color: #475569;
        border: 1px solid #cbd5f5;
      }

      .modal-content .link-button {
        background: transparent;
        color: #2563eb;
        border: none;
        padding: 0;
        font-size: 0.95rem;
        text-decoration: underline;
        cursor: pointer;
        align-self: flex-start;
      }

      .modal.show,
      .modal-overlay.show {
        display: flex;
      }

      .form-feedback {
        font-size: 0.9rem;
        padding: 0.5rem 0.75rem;
        border-radius: 10px;
        background: #fef3c7;
        color: #92400e;
        display: none;
      }

      .form-feedback.success {
        background: #dcfce7;
        color: #166534;
      }

      .form-feedback.error {
        background: #fee2e2;
        color: #b91c1c;
      }
    </style>
  </head>
  <body>
    <div class="page">
      <nav>
        <div class="nav-content">
          <div class="brand">
            <span>ArriendosTalca</span>
            <span>Portal de Arriendos</span>
          </div>
          <div class="nav-links">
            <a href="#" class="active">Inicio</a>
            <a href="#propiedades">Propiedades</a>
            <span id="auth-indicator" class="auth-indicator">Visitante</span>
            <button type="button" data-action="login">Iniciar Sesión</button>
            <button type="button" class="primary" data-action="signup">Registrarse</button>
          </div>
        </div>
      </nav>

      <header class="hero">
        <div class="hero-content">
          <h1>Encuentra tu hogar ideal en Talca</h1>
          <p>Solo mostramos inmuebles de la Región del Maule, con datos frescos obtenidos por scraping.</p>

          <form id="filters-form" class="filters-card">
            <div class="pill-group">
              <div class="pill">
                <span>Región</span>
                <span>Maule</span>
              </div>
              <div class="pill">
                <span>Categoría</span>
                <span>Inmuebles</span>
              </div>
            </div>
            <input type="hidden" name="region" value="maule" />
            <input type="hidden" name="category" value="inmuebles" />

            <label>
              Búsqueda rápida
              <input type="text" name="search" placeholder="Ej: departamento 2 dorm" />
            </label>

            <label>
              Página
              <input type="number" name="page" min="1" value="1" />
            </label>

            <label>
              Límite
              <input type="number" name="limit" min="1" max="60" value="24" />
            </label>

            <button type="submit">Buscar</button>
          </form>
        </div>
      </header>

      <main>
        <div id="status">Listo para consultar.</div>
        <ul id="warnings"></ul>
        <h2 class="section-heading" id="propiedades">Propiedades Destacadas</h2>
        <section id="cards" class="grid"></section>
      </main>

      <footer>
        Datos obtenidos desde `/api/yapo-listings`. Inicia el backend antes de usar esta vista.
      </footer>
    </div>

    <div id="modal-overlay" class="modal-overlay"></div>

    <section id="login-modal" class="modal" aria-hidden="true">
      <div class="modal-content">
        <div>
          <h3>Iniciar sesión</h3>
          <p>Usa tus credenciales registradas para continuar.</p>
        </div>
        <form id="login-form">
          <label>
            Correo electrónico
            <input type="email" name="email" placeholder="tu@email.com" required />
          </label>
          <label>
            Contraseña
            <input type="password" name="password" placeholder="********" minlength="6" required />
          </label>
          <p class="form-feedback" data-feedback="login"></p>
          <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
            <button type="submit">Ingresar</button>
            <button type="button" class="secondary" data-close-modal="login">Cancelar</button>
          </div>
          <button type="button" class="link-button" data-open-modal="password">¿Olvidaste tu contraseña?</button>
        </form>
      </div>
    </section>

    <section id="signup-modal" class="modal" aria-hidden="true">
      <div class="modal-content">
        <div>
          <h3>Crear cuenta</h3>
          <p>Registra un correo y contraseña para guardar tus búsquedas.</p>
        </div>
        <form id="signup-form">
          <label>
            Correo electrónico
            <input type="email" name="email" placeholder="tu@email.com" required />
          </label>
          <label>
            Contraseña (mínimo 6 caracteres)
            <input type="password" name="password" placeholder="********" minlength="6" required />
          </label>
          <p class="form-feedback" data-feedback="signup"></p>
          <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
            <button type="submit">Registrarme</button>
            <button type="button" class="secondary" data-close-modal="signup">Cancelar</button>
          </div>
        </form>
      </div>
    </section>

    <section id="password-modal" class="modal" aria-hidden="true">
      <div class="modal-content">
        <div>
          <h3>Recuperar contraseña</h3>
          <p>Genera un token y úsalo para definir una nueva contraseña.</p>
        </div>
        <form id="reset-request-form">
          <label>
            Correo asociado
            <input type="email" name="email" placeholder="tu@email.com" required />
          </label>
          <p class="form-feedback" data-feedback="reset-request"></p>
          <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
            <button type="submit">Generar token</button>
            <button type="button" class="secondary" data-close-modal="password">Cerrar</button>
          </div>
        </form>
        <hr style="width:100%; border:none; border-top:1px solid #e2e8f0;" />
        <form id="reset-confirm-form">
          <label>
            Token recibido
            <input type="text" name="token" placeholder="Ingresa el token" required />
          </label>
          <label>
            Nueva contraseña
            <input type="password" name="password" placeholder="********" minlength="6" required />
          </label>
          <label>
            Confirmar contraseña
            <input type="password" name="confirmPassword" placeholder="********" minlength="6" required />
          </label>
          <p class="form-feedback" data-feedback="reset-confirm"></p>
          <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
            <button type="submit">Actualizar contraseña</button>
            <button type="button" class="secondary" data-close-modal="password">Cancelar</button>
          </div>
        </form>
      </div>
    </section>

    <script>
      const API_BASE = 'http://localhost:5000/api/yapo-listings';
      const AUTH_BASE = 'http://localhost:5000/api/auth';
      const TOKEN_KEY = 'at_auth_token';
      const EMAIL_KEY = 'at_auth_email';
      const form = document.getElementById('filters-form');
      const statusEl = document.getElementById('status');
      const cardsContainer = document.getElementById('cards');
      const warningsEl = document.getElementById('warnings');
      const overlay = document.getElementById('modal-overlay');
      const loginModal = document.getElementById('login-modal');
      const signupModal = document.getElementById('signup-modal');
      const passwordModal = document.getElementById('password-modal');
      const loginBtn = document.querySelector('[data-action="login"]');
      const signupBtn = document.querySelector('[data-action="signup"]');
      const forgotPasswordBtn = document.querySelector('[data-open-modal="password"]');
      const authIndicator = document.getElementById('auth-indicator');
      const loginForm = document.getElementById('login-form');
      const signupForm = document.getElementById('signup-form');
      const resetRequestForm = document.getElementById('reset-request-form');
      const resetConfirmForm = document.getElementById('reset-confirm-form');

      const formDataToParams = (formData) => {
        const params = {};
        for (const [key, value] of formData.entries()) {
          if (value) {
            params[key] = value;
          }
        }
        return params;
      };

      const renderWarnings = (warnings = []) => {
        warningsEl.innerHTML = '';
        warnings.forEach((warning) => {
          const li = document.createElement('li');
          li.textContent = warning;
          warningsEl.appendChild(li);
        });
      };

      const renderListings = (listings) => {
        cardsContainer.innerHTML = '';
        if (!listings || listings.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'empty-state';
          empty.textContent = 'No se encontraron resultados para los filtros seleccionados.';
          cardsContainer.appendChild(empty);
          return;
        }

        listings.forEach((item) => {
          const card = document.createElement('article');
          card.className = 'card';

          if (item.image) {
            const img = document.createElement('img');
            img.src = item.image;
            img.alt = item.title || 'Imagen del aviso';
            card.appendChild(img);
          }

          const body = document.createElement('div');
          body.className = 'card-body';

          const title = document.createElement('h3');
          title.textContent = item.title || 'Aviso sin título';
          body.appendChild(title);

          if (item.price) {
            const price = document.createElement('p');
            price.className = 'price';
            price.textContent = item.price;
            body.appendChild(price);
          }

          if (item.location || item.seller) {
            const meta = document.createElement('p');
            meta.className = 'meta';
            meta.textContent = [item.location, item.seller].filter(Boolean).join(' · ');
            body.appendChild(meta);
          }

          if (item.description) {
            const desc = document.createElement('p');
            desc.textContent = item.description;
            body.appendChild(desc);
          }

          if (item.link) {
            const anchor = document.createElement('a');
            anchor.href = item.link;
            anchor.target = '_blank';
            anchor.rel = 'noopener noreferrer';
            anchor.textContent = 'Ver aviso';
            body.appendChild(anchor);
          }

          card.appendChild(body);
          cardsContainer.appendChild(card);
        });
      };

      const fetchListings = async (params = {}) => {
        const url = new URL(API_BASE);
        Object.entries(params).forEach(([key, value]) => url.searchParams.set(key, value));

        statusEl.textContent = 'Consultando Yapo...';
        statusEl.style.color = '#38bdf8';

        try {
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
          }

          const payload = await response.json();
          statusEl.textContent = `Recibidos ${payload.meta?.total ?? 0} avisos (mostrando ${payload.listings?.length ?? 0}).`;
          statusEl.style.color = '#22c55e';
          renderWarnings(payload.warnings || []);
          renderListings(payload.listings || []);
        } catch (error) {
          console.error(error);
          statusEl.textContent = `Error consultando el backend: ${error.message}`;
          statusEl.style.color = '#f87171';
          renderListings([]);
        }
      };

      form.addEventListener('submit', (event) => {
        event.preventDefault();
        const params = formDataToParams(new FormData(form));
        fetchListings(params);
      });

      const setFeedback = (type, message, variant = 'error') => {
        const el = document.querySelector(`[data-feedback="${type}"]`);
        if (!el) return;
        if (!message) {
          el.style.display = 'none';
          el.textContent = '';
          el.classList.remove('success', 'error');
          return;
        }
        el.textContent = message;
        el.style.display = 'block';
        el.classList.remove('success', 'error');
        if (variant === 'success') el.classList.add('success');
        if (variant === 'error') el.classList.add('error');
      };

      const toggleModal = (modal, show) => {
        if (!modal) return;
        if (show) {
          modal.classList.add('show');
          overlay.classList.add('show');
        } else {
          modal.classList.remove('show');
          overlay.classList.remove('show');
          modal.querySelectorAll('.form-feedback').forEach((el) => {
            const type = el.getAttribute('data-feedback');
            if (type) setFeedback(type, '');
          });
          modal.querySelectorAll('form').forEach((formEl) => formEl.reset());
        }
      };

      const isAuthenticated = () => Boolean(localStorage.getItem(TOKEN_KEY));

      const updateAuthUI = () => {
        if (isAuthenticated()) {
          const email = localStorage.getItem(EMAIL_KEY) || 'Usuario autenticado';
          authIndicator.textContent = email;
          loginBtn.textContent = 'Cerrar sesión';
          signupBtn.style.display = 'none';
        } else {
          authIndicator.textContent = 'Visitante';
          loginBtn.textContent = 'Iniciar Sesión';
          signupBtn.style.display = '';
        }
      };

      loginBtn.addEventListener('click', () => {
        if (isAuthenticated()) {
          localStorage.removeItem(TOKEN_KEY);
          localStorage.removeItem(EMAIL_KEY);
          updateAuthUI();
          statusEl.textContent = 'Sesión cerrada correctamente.';
          statusEl.style.color = '#475569';
          return;
        }
        toggleModal(loginModal, true);
      });

      signupBtn.addEventListener('click', () => toggleModal(signupModal, true));
      overlay.addEventListener('click', () => {
        toggleModal(loginModal, false);
        toggleModal(signupModal, false);
        toggleModal(passwordModal, false);
      });
      document.querySelectorAll('[data-close-modal]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const target = btn.getAttribute('data-close-modal');
          if (target === 'login') toggleModal(loginModal, false);
          if (target === 'signup') toggleModal(signupModal, false);
          if (target === 'password') toggleModal(passwordModal, false);
        });
      });

      if (forgotPasswordBtn) {
        forgotPasswordBtn.addEventListener('click', () => toggleModal(passwordModal, true));
      }

      loginForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        setFeedback('login', 'Verificando credenciales...', 'success');
        const data = Object.fromEntries(new FormData(loginForm).entries());
        try {
          const response = await fetch(`${AUTH_BASE}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });
          const payload = await response.json();
          if (!response.ok) {
            throw new Error(payload.message || 'No se pudo iniciar sesión');
          }
          localStorage.setItem(TOKEN_KEY, payload.token);
          localStorage.setItem(EMAIL_KEY, data.email);
          setFeedback('login', 'Inicio de sesión exitoso.', 'success');
          toggleModal(loginModal, false);
          updateAuthUI();
          statusEl.textContent = 'Sesión iniciada. Puedes acceder a rutas protegidas.';
          statusEl.style.color = '#22c55e';
        } catch (error) {
          setFeedback('login', error.message, 'error');
        }
      });

      signupForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        setFeedback('signup', 'Creando cuenta...', 'success');
        const data = Object.fromEntries(new FormData(signupForm).entries());
        try {
          const response = await fetch(`${AUTH_BASE}/signup`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });
          const payload = await response.json();
          if (!response.ok) {
            throw new Error(payload.message || 'No se pudo registrar');
          }
          setFeedback('signup', 'Cuenta creada. Ahora inicia sesión.', 'success');
          signupForm.reset();
        } catch (error) {
          setFeedback('signup', error.message, 'error');
        }
      });

      if (resetRequestForm) {
        resetRequestForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          setFeedback('reset-request', 'Generando token de recuperación...', 'success');
          const data = Object.fromEntries(new FormData(resetRequestForm).entries());
          try {
            const response = await fetch(`${AUTH_BASE}/forgot-password`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data),
            });
            const payload = await response.json();
            if (!response.ok) {
              throw new Error(payload.message || 'No se pudo generar el token');
            }
            const tokenNote = payload.token ? ` Token: ${payload.token}` : '';
            setFeedback('reset-request', `${payload.message || 'Solicitud enviada.'}${tokenNote}`, 'success');
            resetRequestForm.reset();
          } catch (error) {
            setFeedback('reset-request', error.message, 'error');
          }
        });
      }

      if (resetConfirmForm) {
        resetConfirmForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          const dataEntries = Object.fromEntries(new FormData(resetConfirmForm).entries());
          if (dataEntries.password !== dataEntries.confirmPassword) {
            setFeedback('reset-confirm', 'Las contraseñas no coinciden.', 'error');
            return;
          }
          setFeedback('reset-confirm', 'Actualizando contraseña...', 'success');
          try {
            const response = await fetch(`${AUTH_BASE}/reset-password`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ token: dataEntries.token, password: dataEntries.password }),
            });
            const payload = await response.json();
            if (!response.ok) {
              throw new Error(payload.message || 'No se pudo actualizar la contraseña');
            }
            setFeedback('reset-confirm', payload.message || 'Contraseña actualizada.', 'success');
            resetConfirmForm.reset();
            setTimeout(() => toggleModal(passwordModal, false), 1500);
          } catch (error) {
            setFeedback('reset-confirm', error.message, 'error');
          }
        });
      }

      updateAuthUI();

      // Carga inicial
      fetchListings({ region: 'maule', category: 'inmuebles', limit: 24, page: 1 });
    </script>
  </body>
</html>
