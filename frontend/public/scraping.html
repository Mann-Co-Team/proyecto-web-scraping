<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HabiTalca - Resultados de Scraping</title>
    <style>
      :root {
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: #0f172a;
        background-color: #f8fafc;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
        background: linear-gradient(180deg, #f8fafc 0%, #eef2ff 45%, #fdf2f8 100%);
        color: #0f172a;
      }

      body.no-scroll {
        overflow: hidden;
      }

      .page {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      nav {
        width: 100%;
        background: rgba(255, 255, 255, 0.85);
        border-bottom: 1px solid rgba(226, 232, 240, 0.7);
        position: sticky;
        top: 0;
        z-index: 10;
        backdrop-filter: blur(10px);
      }

      .nav-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0.75rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      .brand {
        display: flex;
        flex-direction: column;
        line-height: 1.1;
      }

      .brand-button {
        border: none;
        background: none;
        text-align: left;
        padding: 0;
        cursor: pointer;
      }

      .brand-button span:first-child {
        font-weight: 700;
        color: #1d4ed8;
        font-size: 1.2rem;
      }

      .brand-button span:last-child {
        font-size: 0.85rem;
        color: #64748b;
      }

      .brand span:first-child {
        font-weight: 700;
        color: #1d4ed8;
        font-size: 1.2rem;
      }

      .brand span:last-child {
        font-size: 0.85rem;
        color: #64748b;
      }

      .nav-links {
        display: flex;
        gap: 0.75rem;
        align-items: center;
      }

      .nav-links a {
        text-decoration: none;
        color: #0f172a;
        font-weight: 500;
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
      }

      .nav-links a.active {
        background: #e0e7ff;
        color: #4338ca;
      }

      .nav-links button {
        border-radius: 999px;
        border: 1px solid #d5dbe7;
        background: #fff;
        padding: 0.4rem 1rem;
        font-weight: 600;
        cursor: pointer;
      }

      .nav-links button.primary {
        background: #0f766e;
        color: #fff;
        border-color: #0f766e;
      }

      .windows-layout {
        display: block;
        margin-top: 2rem;
      }

      .app-window {
        background: #fff;
        border-radius: 28px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 20px 60px rgba(15, 23, 42, 0.12);
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .app-window__header {
        padding: 1.5rem 1.75rem 1rem;
        border-bottom: 1px solid #e2e8f0;
      }

      .app-window__header h2 {
        margin: 0.25rem 0 0.4rem;
        font-size: 1.5rem;
        color: #0f172a;
      }

      .window-eyebrow {
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 0.75rem;
        color: #94a3b8;
        margin: 0;
      }

      .app-window__body {
        padding: 1.75rem;
      }

      .page.profile-view .hero,
      .page.profile-view .windows-layout {
        display: none;
      }

      #profile-window {
        display: none;
        margin-top: 2rem;
      }

      .page.profile-view #profile-window {
        display: block;
      }

      .window-back {
        display: none;
        align-items: center;
        gap: 0.35rem;
        border: none;
        background: none;
        color: #1d4ed8;
        font-weight: 600;
        cursor: pointer;
        padding: 0;
      }

      .page.profile-view .window-back {
        display: inline-flex;
      }

      .window-back svg {
        width: 1em;
        height: 1em;
      }

      .profile-panel {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
      }

      .profile-panel .description {
        margin: 0;
        color: #475569;
      }

      .profile-panel form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .profile-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .password-fields {
        display: none;
        flex-direction: column;
        gap: 0.85rem;
        padding: 1rem;
        border-radius: 12px;
        border: 1px dashed #cbd5f5;
        background: #f8fafc;
      }

      .password-fields.show {
        display: flex;
      }

      .profile-empty {
        margin-top: 1rem;
        padding: 1rem;
        border-radius: 12px;
        background: #fef3c7;
        border: 1px solid #fcd34d;
        color: #92400e;
      }

      .hidden {
        display: none !important;
      }

      .auth-indicator {
        font-size: 0.85rem;
        color: #475569;
        background: #e2e8f0;
        padding: 0.3rem 0.75rem;
        border-radius: 999px;
      }

      .hero {
        background: linear-gradient(135deg, #f5f7ff 0%, #ffffff 45%, #f0f9ff 100%);
        padding: clamp(2rem, 4vw, 3.5rem) 1.5rem 2rem;
      }

      .hero-content {
        max-width: 1050px;
        margin: 0 auto;
        text-align: center;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .hero h1 {
        margin: 0;
        font-size: clamp(2rem, 3vw, 2.8rem);
        color: #0f172a;
      }

      .hero p {
        margin: 0;
        color: #475569;
        font-size: 1.1rem;
      }

      .filters-card {
        margin: 1.5rem auto 0;
        background: #fff;
        border-radius: 24px;
        padding: 2rem;
        box-shadow: 0 20px 60px rgba(15, 23, 42, 0.12);
        display: grid;
        gap: 1.2rem;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        align-items: start;
        max-width: 980px;
      }

      .pill-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.75rem;
        margin-bottom: 0.5rem;
      }

      .pill {
        border-radius: 14px;
        border: 1px solid #e2e8f0;
        background: #f8fafc;
        padding: 0.7rem 1rem;
        display: flex;
        flex-direction: column;
        text-align: left;
      }

      .pill span:first-child {
        font-size: 0.8rem;
        color: #94a3b8;
      }

      .pill span:last-child {
        font-weight: 600;
        color: #0f172a;
      }

      label {
        display: flex;
        flex-direction: column;
        gap: 0.45rem;
        font-size: 0.92rem;
        color: #475569;
        text-align: left;
      }

      input,
      select {
        border: 1px solid #cbd5f5;
        border-radius: 12px;
        padding: 0.7rem 0.9rem;
        font-size: 1rem;
        background: #f8fafc;
        color: #0f172a;
      }

      .filters-card button {
        border: none;
        border-radius: 14px;
        padding: 0.95rem 1.25rem;
        font-size: 1rem;
        font-weight: 600;
        background: #0f766e;
        color: #fff;
        cursor: pointer;
        box-shadow: 0 12px 30px rgba(15, 118, 110, 0.25);
        grid-column: 1 / -1;
        width: 100%;
      }

      .inline-input-pair {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.75rem;
      }

      main {
        width: min(1280px, 100% - 2rem);
        margin: 2rem auto 3rem;
        padding: 0 0 3rem;
        flex: 1;
      }

      #status {
        margin: 0 0 0.5rem;
        padding: 0.75rem 1.25rem;
        border-radius: 12px;
        background: #e0f2fe;
        border: 1px solid #bae6fd;
        color: #075985;
        min-height: 3rem;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
      }

      #warnings {
        margin: 0 0 1rem;
        padding-left: 1.25rem;
        color: #b45309;
      }

      .section-heading {
        margin: 2.5rem 0 1rem;
        font-size: 1.75rem;
        color: #0f172a;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 1.5rem;
      }

      .card {
        border-radius: 24px;
        overflow: hidden;
        border: 1px solid #e2e8f0;
        background: #fff;
        box-shadow: 0 18px 45px rgba(15, 23, 42, 0.08);
        display: flex;
        flex-direction: column;
        min-height: 420px;
        transition: transform 160ms ease, box-shadow 160ms ease;
      }

      .card--interactive {
        cursor: pointer;
      }

      .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 30px 60px rgba(15, 23, 42, 0.15);
      }

      .card img {
        width: 100%;
        height: 210px;
        object-fit: cover;
      }

      .card-body {
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.65rem;
        flex: 1;
      }

      .card-details {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin: 0;
        padding: 0;
        list-style: none;
        color: #475569;
        font-size: 0.9rem;
      }

      .card-details__item {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
      }

      .card-details__icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #0f172a;
      }

      .card-details__icon svg {
        width: 18px;
        height: 18px;
        stroke: currentColor;
        fill: none;
        stroke-width: 1.5;
      }

      .card h3 {
        margin: 0;
        font-size: 1.2rem;
        color: #0f172a;
      }

      .price {
        font-size: 1.2rem;
        color: #0369a1;
        font-weight: 700;
      }

      .meta {
        font-size: 0.95rem;
        color: #475569;
        display: flex;
        gap: 0.4rem;
        align-items: center;
      }

      .meta span {
        display: inline-flex;
        align-items: center;
        gap: 0.2rem;
      }

      .card a {
        margin-top: auto;
        color: #0f766e;
        text-decoration: none;
        font-weight: 600;
      }

      .empty-state {
        grid-column: 1 / -1;
        text-align: center;
        padding: 4rem 2rem;
        border-radius: 24px;
        background: #f1f5f9;
        border: 1px dashed #cbd5f5;
        color: #475569;
      }

      footer {
        border-top: 1px solid #e2e8f0;
        background: #fff;
        text-align: center;
        padding: 1.5rem 1rem;
        color: #64748b;
        font-size: 0.95rem;
      }

      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        backdrop-filter: blur(2px);
        display: none;
        z-index: 50;
      }

      .modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 60;
        padding: 1rem;
      }

      .modal-content {
        width: min(420px, 100%);
        background: #fff;
        border-radius: 24px;
        padding: 2rem;
        box-shadow: 0 30px 70px rgba(15, 23, 42, 0.2);
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .modal-content h3 {
        margin: 0;
        font-size: 1.5rem;
        color: #0f172a;
      }

      .modal-content p {
        margin: 0;
        color: #475569;
        font-size: 0.95rem;
      }

      .modal-content form {
        display: flex;
        flex-direction: column;
        gap: 0.85rem;
      }

      .modal-content input {
        width: 100%;
      }

      .modal-content button[type='submit'] {
        border: none;
        border-radius: 12px;
        padding: 0.85rem 1rem;
        background: #2563eb;
        color: #fff;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
      }

      .modal-content .secondary {
        background: transparent;
        color: #475569;
        border: 1px solid #cbd5f5;
      }

      .modal-content .link-button {
        background: transparent;
        color: #2563eb;
        border: none;
        padding: 0;
        font-size: 0.95rem;
        text-decoration: underline;
        cursor: pointer;
        align-self: flex-start;
      }

      .modal.show,
      .modal-overlay.show {
        display: flex;
      }

      .property-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        backdrop-filter: blur(4px);
        display: none;
        z-index: 110;
      }

      .property-modal-overlay.show {
        display: block;
      }

      .property-modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
        z-index: 111;
      }

      .property-modal.show {
        display: flex;
      }

      .property-modal__panel {
        width: min(960px, 100%);
        max-height: 90vh;
        background: #fff;
        border-radius: 28px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 40px 90px rgba(15, 23, 42, 0.35);
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .property-modal__media {
        width: 100%;
        aspect-ratio: 16 / 9;
        background: #f1f5f9;
        position: relative;
      }

      .property-modal__media img {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .property-modal__body {
        padding: 1.75rem;
        overflow-y: auto;
      }

      .property-modal__header {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        margin-bottom: 1.25rem;
      }

      .property-modal__title {
        margin: 0;
        font-size: 1.75rem;
        color: #0f172a;
      }

      .property-modal__meta {
        color: #475569;
        font-size: 0.95rem;
      }

      .property-modal__price {
        font-size: 1.4rem;
        font-weight: 700;
        color: #0f766e;
      }

      .property-modal__details {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin: 0 0 1.25rem;
        padding: 0;
        list-style: none;
      }

      .property-modal__detail {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.5rem 0.85rem;
        border-radius: 999px;
        background: #f1f5f9;
        color: #0f172a;
        font-weight: 600;
        font-size: 0.9rem;
      }

      .property-modal__detail-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #0f172a;
      }

      .property-modal__detail-icon svg {
        width: 18px;
        height: 18px;
        stroke: currentColor;
        fill: none;
        stroke-width: 1.5;
      }

      .property-modal__description {
        white-space: pre-line;
        line-height: 1.5;
        color: #1f2937;
      }

      .property-modal__actions {
        margin-top: 1.5rem;
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      .property-modal__actions a,
      .property-modal__actions button {
        border-radius: 999px;
        border: 1px solid #1d4ed8;
        background: #1d4ed8;
        color: #fff;
        padding: 0.6rem 1.25rem;
        font-weight: 600;
        cursor: pointer;
      }

      .property-modal__close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        border: none;
        background: rgba(15, 23, 42, 0.65);
        color: #fff;
        border-radius: 999px;
        width: 36px;
        height: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      .form-feedback {
        font-size: 0.9rem;
        padding: 0.5rem 0.75rem;
        border-radius: 10px;
        background: #fef3c7;
        color: #92400e;
        display: none;
      }

      .form-feedback.success {
        background: #dcfce7;
        color: #166534;
      }

      .properties-container {
        display: grid;
        grid-template-columns: minmax(260px, 320px) minmax(0, 1fr);
        gap: 2rem;
        align-items: flex-start;
      }

      .sidebar {
        width: 280px;
        flex-shrink: 0;
        background: #fff;
        color: #0f172a;
        border-radius: 16px;
        padding: 1.5rem;
        position: sticky;
        top: 90px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.05);
      }

      .sidebar h3 {
        margin: 0 0 1.5rem;
        font-size: 1.25rem;
        font-weight: 700;
        color: #0f172a;
      }

      .sidebar label {
        color: #475569;
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
      }

      .sidebar select {
        width: 100%;
        background: #f8fafc;
        border: 1px solid #cbd5f5;
        color: #0f172a;
        margin-bottom: 1.25rem;
      }

      .sidebar-group {
        margin-bottom: 1.5rem;
      }

      .sidebar-slider-container {
        margin-bottom: 1.5rem;
      }

      .sidebar-slider {
        width: 100%;
        height: 6px;
        background: #cbd5f5;
        border-radius: 3px;
        outline: none;
        -webkit-appearance: none;
        appearance: none;
        cursor: pointer;
      }

      .sidebar-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        background: #0f766e;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid #fff;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }

      .sidebar-slider::-moz-range-thumb {
        width: 18px;
        height: 18px;
        background: #0f766e;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid #fff;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }

      .price-display {
        color: #0f766e;
        font-weight: 600;
        font-size: 1.1rem;
        margin-top: 0.5rem;
        display: block;
      }

      .checkbox-group {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
        font-size: 0.95rem;
        color: #475569;
      }

      .checkbox-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        border-radius: 4px;
        border: 2px solid #cbd5f5;
        background: #f8fafc;
        appearance: none;
        -webkit-appearance: none;
        cursor: pointer;
        position: relative;
      }

      .checkbox-item input[type="checkbox"]:checked {
        background: #0f766e;
        border-color: #0f766e;
      }

      .checkbox-item input[type="checkbox"]:checked::after {
        content: '✓';
        position: absolute;
        color: #fff;
        font-size: 12px;
        left: 3px;
        top: 0px;
      }

      .sidebar button.apply-btn {
        width: 100%;
        background: #0f766e;
        color: #fff;
        font-weight: 700;
        padding: 0.85rem;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        margin-top: 1rem;
        transition: background 0.2s, transform 0.1s;
        box-shadow: 0 4px 12px rgba(15, 118, 110, 0.2);
      }

      .sidebar button.apply-btn:hover {
        background: #115e59;
        transform: translateY(-1px);
      }

      /* Adjust grid for sidebar layout */
      .properties-content {
        flex: 1;
      }

      .pagination-toolbar {
        margin: 1.25rem 0 1.75rem;
        display: flex;
        flex-direction: column;
        gap: 0.85rem;
      }

      .pagination-toolbar.hidden {
        display: none;
      }

      .pagination-toolbar__top {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 0.75rem;
        align-items: center;
      }

      .pagination-summary-text {
        margin: 0;
        font-weight: 600;
        color: #475569;
      }

      .load-all-button {
        border-radius: 999px;
        border: 1px solid #f97316;
        background: #fff7ed;
        color: #c2410c;
        font-weight: 600;
        padding: 0.45rem 1rem;
        cursor: pointer;
        transition: background 0.2s ease, color 0.2s ease;
      }

      .load-all-button.is-active {
        background: #f97316;
        color: #fff;
        border-color: #f97316;
      }

      .pagination-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
        align-items: center;
      }

      .pagination-button {
        border: 1px solid #e2e8f0;
        background: #fff;
        color: #0f172a;
        border-radius: 12px;
        padding: 0.35rem 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease, color 0.2s ease, border 0.2s ease;
      }

      .pagination-button:is([disabled]) {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .pagination-button.is-active {
        background: #f97316;
        border-color: #f97316;
        color: #fff;
        box-shadow: 0 6px 18px rgba(249, 115, 22, 0.3);
      }

      .pagination-button.no-results:not(.is-active) {
        opacity: 0.55;
        border-style: dashed;
      }

      .pagination-ellipsis {
        color: #94a3b8;
        font-weight: 600;
        padding: 0 0.35rem;
      }

      @media (min-width: 768px) {
        .pagination-toolbar__top {
          flex-wrap: nowrap;
        }
      }

      .card-page-badge {
        align-self: flex-start;
        background: #fff7ed;
        color: #c2410c;
        border: 1px solid #fed7aa;
        border-radius: 999px;
        padding: 0.15rem 0.65rem;
        font-size: 0.75rem;
        font-weight: 700;
      }

      .history-extension {
        position: fixed;
        right: 1.5rem;
        bottom: 1.5rem;
        width: min(340px, 90vw);
        z-index: 120;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .history-toggle {
        border-radius: 999px;
        border: 1px solid #f97316;
        background: #fff7ed;
        color: #9a3412;
        font-weight: 700;
        padding: 0.5rem 1rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        box-shadow: 0 10px 25px rgba(249, 115, 22, 0.35);
      }

      .history-count {
        min-width: 2rem;
        height: 2rem;
        border-radius: 999px;
        background: #f97316;
        color: #fff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
      }

      .history-extension__card {
        border-radius: 20px;
        background: #ffffff;
        border: 1px solid #e2e8f0;
        box-shadow: 0 25px 45px rgba(15, 23, 42, 0.18);
        padding: 1.25rem;
        display: none;
      }

      .history-extension--open .history-extension__card {
        display: block;
      }

      .history-panel__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        margin-bottom: 1rem;
      }

      .history-panel__header h3 {
        margin: 0;
        font-size: 1rem;
        color: #0f172a;
      }

      .history-clear-btn {
        border-radius: 999px;
        border: 1px solid #e2e8f0;
        background: #f8fafc;
        color: #475569;
        font-weight: 600;
        padding: 0.3rem 0.85rem;
        cursor: pointer;
      }

      .history-clear-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .history-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 0.65rem;
        max-height: 320px;
        overflow-y: auto;
      }

      .history-entry {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        padding: 0.65rem 0.75rem;
        border-radius: 12px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
      }

      .history-entry__title {
        margin: 0;
        font-size: 0.95rem;
        color: #0f172a;
      }

      .history-entry__meta {
        margin: 0;
        color: #64748b;
        font-size: 0.8rem;
      }

      .history-entry__actions {
        display: flex;
        gap: 0.35rem;
      }

      .history-entry__actions a {
        border-radius: 999px;
        border: 1px solid #dbeafe;
        background: #eff6ff;
        color: #1d4ed8;
        padding: 0.25rem 0.75rem;
        font-size: 0.85rem;
        font-weight: 600;
        text-decoration: none;
      }

      .history-empty {
        margin: 0;
        color: #94a3b8;
        font-style: italic;
      }
      
      /* Hide old filters card styles if needed or reuse for search */
      .search-hero-form {
        max-width: 600px;
        margin: 0 auto;
        display: flex;
        gap: 0.5rem;
      }
      
      .search-hero-form input {
        flex: 1;
        padding: 1rem 1.5rem;
        border-radius: 99px;
        border: 1px solid #cbd5f5;
        box-shadow: 0 10px 25px rgba(0,0,0,0.05);
      }

      .search-hero-form button {
        border-radius: 99px;
        padding: 0 2rem;
        background: #0f766e;
        color: #fff;
        font-weight: 600;
        border: none;
        cursor: pointer;
      }

      .password-field {
        position: relative;
        display: flex;
        align-items: center;
      }

      .password-field input {
        flex: 1;
        padding-right: 2.5rem;
      }

      .password-toggle {
        position: absolute;
        right: 0.75rem;
        border: none;
        background: transparent;
        color: #475569;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        width: 1.75rem;
        height: 1.75rem;
      }

      .password-toggle svg {
        width: 20px;
        height: 20px;
        stroke: currentColor;
        fill: none;
        stroke-width: 1.6;
      }

      .password-toggle .icon-eye-off {
        display: none;
      }

      .password-toggle.is-active {
        color: #0f766e;
      }

      .password-toggle.is-active .icon-eye {
        display: none;
      }

      .password-toggle.is-active .icon-eye-off {
        display: block;
      }

      .toast-stack {
        position: fixed;
        top: 1.5rem;
        right: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        align-items: flex-end;
        z-index: 2000;
        pointer-events: none;
      }

      .toast {
        min-width: 240px;
        background: #fff;
        border-radius: 14px;
        border: 1px solid #e2e8f0;
        padding: 0.85rem 1rem;
        color: #0f172a;
        font-weight: 600;
        box-shadow: 0 16px 35px rgba(15, 23, 42, 0.18);
        opacity: 0;
        transform: translateY(-10px);
        transition: opacity 0.2s ease, transform 0.2s ease;
      }

      .toast--visible {
        opacity: 1;
        transform: translateY(0);
      }

      .toast--success {
        border-color: #86efac;
        background: #ecfdf5;
        color: #065f46;
      }

      .toast--info {
        border-color: #bae6fd;
        background: #e0f2fe;
        color: #0f172a;
      }

      .toast--warning {
        border-color: #fcd34d;
        background: #fef3c7;
        color: #92400e;
      }

      .toast--error {
        border-color: #fca5a5;
        background: #fee2e2;
        color: #b91c1c;
      }

      @media (max-width: 900px) {
        .properties-container {
          grid-template-columns: 1fr;
        }
        .sidebar {
          width: 100%;
          position: static;
          margin-bottom: 2rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div id="toast-stack" class="toast-stack" role="status" aria-live="polite"></div>
      <nav>
        <div class="nav-content">
          <button type="button" class="brand-button" id="brand-home" aria-label="Volver a inicio">
            <span>HabiTalca</span>
            <span>Portal de Arriendos</span>
          </button>
          <div class="nav-links">
            <span id="auth-indicator" class="auth-indicator">Visitante</span>
            <button type="button" data-action="profile-tab" style="display:none;">Mi perfil</button>
            <button type="button" data-action="login">Iniciar Sesión</button>
            <button type="button" class="primary" data-action="signup">Registrarse</button>
          </div>
        </div>
      </nav>

      <header class="hero">
        <div class="hero-content">
          <h1>Encuentra tu hogar ideal en Talca</h1>
          <p>Solo mostramos inmuebles de la Región del Maule, con datos frescos obtenidos por scraping.</p>

          <form id="hero-search-form" class="search-hero-form">
            <input type="text" name="search" placeholder="Ej: departamento 2 dorm" />
            <button type="submit">Buscar</button>
          </form>
        </div>
      </header>

      <main>
        <div class="windows-layout">
          <section id="propiedades" class="app-window app-window--wide">
            <div class="app-window__header">
              <p class="window-eyebrow">Listado en vivo</p>
              <h2>Propiedades en arriendo</h2>
              <p>Aplica filtros y explora los arriendos disponibles en Maule antes que cualquier otro tipo de publicación.</p>
            </div>
            <div class="app-window__body">
              <div class="properties-container">
                <aside class="sidebar">
                  <h3>Filtros</h3>
                  <form id="sidebar-filters-form">
                    <div class="sidebar-group">
                      <label>Tipo de Propiedad</label>
                      <select name="propertyType">
                        <option value="">Todos los tipos</option>
                        <option value="casa">Casa</option>
                        <option value="departamento">Departamento</option>
                        <option value="parcela">Parcela / Terreno</option>
                        <option value="oficina">Oficina / Local</option>
                        <option value="habitacion">Habitación / Pieza</option>
                        <option value="bodega">Bodega / Galpón</option>
                      </select>
                    </div>

                    <div class="sidebar-group">
                      <label>Ubicación</label>
                      <select name="location">
                        <option value="">Todas las ubicaciones</option>
                        <option value="talca">Talca</option>
                        <option value="curicó">Curicó</option>
                        <option value="linares">Linares</option>
                        <option value="cauquenes">Cauquenes</option>
                        <option value="constitución">Constitución</option>
                        <option value="parral">Parral</option>
                        <option value="molina">Molina</option>
                        <option value="san javier">San Javier</option>
                        <option value="maule">Maule</option>
                        <option value="san clemente">San Clemente</option>
                      </select>
                    </div>

                    <div class="sidebar-group">
                      <label>Precio Máximo</label>
                      <div class="sidebar-slider-container">
                        <input type="range" name="maxPrice" min="0" max="2000000" step="50000" value="1000000" class="sidebar-slider" id="sidebar-price-slider">
                        <span class="price-display" id="sidebar-price-display">$1.000.000</span>
                      </div>
                    </div>

                    <div class="sidebar-group">
                      <label>Dormitorios</label>
                      <div class="checkbox-group">
                        <label class="checkbox-item">
                          <input type="checkbox" name="bedrooms" value="1"> 1 dormitorio
                        </label>
                        <label class="checkbox-item">
                          <input type="checkbox" name="bedrooms" value="2"> 2 dormitorios
                        </label>
                        <label class="checkbox-item">
                          <input type="checkbox" name="bedrooms" value="3"> 3 dormitorios
                        </label>
                        <label class="checkbox-item">
                          <input type="checkbox" name="bedrooms" value="4+"> 4+ dormitorios
                        </label>
                      </div>
                    </div>

                    <button type="submit" class="apply-btn">Aplicar Filtros</button>
                  </form>
                </aside>

                <div class="properties-content">
                  <div id="status">Listo para consultar.</div>
                  <ul id="warnings"></ul>
                  <div id="pagination-toolbar" class="pagination-toolbar hidden">
                    <div class="pagination-toolbar__top">
                      <p id="pagination-summary" class="pagination-summary-text">Paginación disponible cuando exista más de una página.</p>
                      <button type="button" id="load-all-pages" class="load-all-button">Cargar todas las páginas</button>
                    </div>
                    <div id="pagination-controls" class="pagination-controls" role="navigation" aria-label="Paginación"></div>
                  </div>
                  <section id="cards" class="grid"></section>
                </div>
              </div>
            </div>
          </section>
        </div>
        <section id="profile-window" class="app-window">
          <div class="app-window__header">
            <button type="button" class="window-back" id="back-to-properties" aria-label="Volver a propiedades">
              <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
              <span>Volver a propiedades</span>
            </button>
            <p class="window-eyebrow">Panel personal</p>
            <h2>Perfil y credenciales</h2>
            <p>Inicia sesión para personalizar tus datos y mantener tu sesión segura.</p>
          </div>
          <div class="app-window__body">
            <div class="profile-panel">
              <p class="description">Completa tu nombre y revisa los datos con los que te registraste.</p>
              <form id="profile-form" class="hidden">
                <label>
                  Nombre completo
                  <input type="text" name="name" placeholder="Tu nombre" />
                </label>
                <label>
                  Correo electrónico
                  <input type="email" name="email" placeholder="tu@email.com" required />
                </label>
                <div class="profile-actions">
                  <button type="submit">Guardar perfil</button>
                  <button type="button" class="secondary" id="toggle-password-fields">Cambiar contraseña</button>
                </div>
                <div id="password-fields" class="password-fields">
                  <label>
                    Nueva contraseña
                    <input type="password" name="password" placeholder="********" minlength="6" />
                  </label>
                  <label>
                    Confirmar contraseña
                    <input type="password" name="confirmPassword" placeholder="********" minlength="6" />
                  </label>
                  <small style="color:#475569;">La contraseña debe tener al menos 6 caracteres.</small>
                </div>
                <p class="form-feedback" data-feedback="profile"></p>
              </form>
              <div id="profile-locked" class="profile-empty">
                Debes iniciar sesión para administrar tu perfil.
              </div>
            </div>
          </div>
        </section>
      </main>

      <footer>
        Datos obtenidos desde `/api/yapo-listings`. Inicia el backend antes de usar esta vista.
      </footer>
    </div>

    <div id="modal-overlay" class="modal-overlay"></div>

    <section id="login-modal" class="modal" aria-hidden="true">
      <div class="modal-content">
        <div>
          <h3>Iniciar sesión</h3>
          <p>Usa tus credenciales registradas para continuar.</p>
        </div>
        <form id="login-form">
          <label>
            Correo electrónico
            <input type="email" name="email" placeholder="tu@email.com" required />
          </label>
          <label>
            Contraseña
            <div class="password-field">
              <input type="password" name="password" id="login-password" placeholder="********" minlength="6" autocomplete="current-password" required />
              <button type="button" class="password-toggle" aria-label="Mostrar contraseña" aria-pressed="false">
                <svg class="icon-eye" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                  <path d="M2.25 12s3.75-6 9.75-6 9.75 6 9.75 6-3.75 6-9.75 6-9.75-6-9.75-6Z" stroke-linecap="round" stroke-linejoin="round" />
                  <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <svg class="icon-eye-off" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                  <path d="M3 3l18 18" stroke-linecap="round" stroke-linejoin="round" />
                  <path d="M10.477 10.477A3 3 0 0 0 13.5 15" stroke-linecap="round" stroke-linejoin="round" />
                  <path d="M6.343 6.343C4.736 7.45 3.375 9.033 2.25 12c0 0 3.75 6 9.75 6 1.87 0 3.5-.45 4.9-1.126" stroke-linecap="round" stroke-linejoin="round" />
                  <path d="M17.657 17.657C19.264 16.55 20.625 14.967 21.75 12c0 0-3.75-6-9.75-6-.88 0-1.715.093-2.505.262" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              </button>
            </div>
          </label>
          <p class="form-feedback" data-feedback="login"></p>
          <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
            <button type="submit">Ingresar</button>
            <button type="button" class="secondary" data-close-modal="login">Cancelar</button>
          </div>
          <button type="button" class="link-button" data-open-modal="password">¿Olvidaste tu contraseña?</button>
        </form>
      </div>
    </section>

    <section id="signup-modal" class="modal" aria-hidden="true">
      <div class="modal-content">
        <div>
          <h3>Crear cuenta</h3>
          <p>Registra un correo y contraseña para guardar tus búsquedas.</p>
        </div>
        <form id="signup-form">
          <label>
            Nombre (opcional)
            <input type="text" name="name" placeholder="Tu nombre" />
          </label>
          <label>
            Correo electrónico
            <input type="email" name="email" placeholder="tu@email.com" required />
          </label>
          <label>
            Contraseña (mínimo 6 caracteres)
            <div class="password-field">
              <input type="password" name="password" id="signup-password" placeholder="********" minlength="6" autocomplete="new-password" required />
              <button type="button" class="password-toggle" aria-label="Mostrar contraseña" aria-pressed="false">
                <svg class="icon-eye" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                  <path d="M2.25 12s3.75-6 9.75-6 9.75 6 9.75 6-3.75 6-9.75 6-9.75-6-9.75-6Z" stroke-linecap="round" stroke-linejoin="round" />
                  <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <svg class="icon-eye-off" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                  <path d="M3 3l18 18" stroke-linecap="round" stroke-linejoin="round" />
                  <path d="M10.477 10.477A3 3 0 0 0 13.5 15" stroke-linecap="round" stroke-linejoin="round" />
                  <path d="M6.343 6.343C4.736 7.45 3.375 9.033 2.25 12c0 0 3.75 6 9.75 6 1.87 0 3.5-.45 4.9-1.126" stroke-linecap="round" stroke-linejoin="round" />
                  <path d="M17.657 17.657C19.264 16.55 20.625 14.967 21.75 12c0 0-3.75-6-9.75-6-.88 0-1.715.093-2.505.262" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              </button>
            </div>
          </label>
          <p class="form-feedback" data-feedback="signup"></p>
          <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
            <button type="submit">Registrarme</button>
            <button type="button" class="secondary" data-close-modal="signup">Cancelar</button>
          </div>
        </form>
      </div>
    </section>

    <section id="password-modal" class="modal" aria-hidden="true">
      <div class="modal-content">
        <div>
          <h3>Recuperar contraseña</h3>
          <p>Te enviaremos un token a tu correo Gmail para confirmar el cambio.</p>
        </div>
        <form id="reset-request-form">
          <label>
            Correo asociado
            <input type="email" name="email" placeholder="tu@email.com" required />
          </label>
          <small style="color:#475569;">Revisa la bandeja de entrada y spam de tu cuenta @gmail.</small>
          <p class="form-feedback" data-feedback="reset-request"></p>
          <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
            <button type="submit">Generar token</button>
            <button type="button" class="secondary" data-close-modal="password">Cerrar</button>
          </div>
        </form>
        <hr style="width:100%; border:none; border-top:1px solid #e2e8f0;" />
        <form id="reset-confirm-form">
          <label>
            Token recibido
            <input type="text" name="token" placeholder="Ingresa el token" required />
          </label>
          <label>
            Nueva contraseña
            <input type="password" name="password" placeholder="********" minlength="6" required />
          </label>
          <label>
            Confirmar contraseña
            <input type="password" name="confirmPassword" placeholder="********" minlength="6" required />
          </label>
          <p class="form-feedback" data-feedback="reset-confirm"></p>
          <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
            <button type="submit">Actualizar contraseña</button>
            <button type="button" class="secondary" data-close-modal="password">Cancelar</button>
          </div>
        </form>
      </div>
    </section>

    <div id="property-modal-overlay" class="property-modal-overlay"></div>
    <section id="property-modal" class="property-modal" aria-hidden="true">
      <div class="property-modal__panel">
        <div class="property-modal__media">
          <img id="property-modal-image" src="" alt="" />
          <button type="button" class="property-modal__close" id="property-modal-close" aria-label="Cerrar ficha">
            ✕
          </button>
        </div>
        <div class="property-modal__body">
          <div class="property-modal__header">
            <p class="property-modal__price" id="property-modal-price"></p>
            <h3 class="property-modal__title" id="property-modal-title"></h3>
            <p class="property-modal__meta" id="property-modal-meta"></p>
          </div>
          <ul class="property-modal__details" id="property-modal-details"></ul>
          <p class="property-modal__description" id="property-modal-description"></p>
          <div class="property-modal__actions">
            <a id="property-modal-link" href="#" target="_blank" rel="noopener noreferrer">Ver aviso original</a>
            <button type="button" id="property-modal-close-secondary">Cerrar</button>
          </div>
        </div>
      </div>
    </section>

    <div class="history-extension" id="history-extension" aria-live="polite">
      <button type="button" class="history-toggle" id="history-toggle" aria-expanded="false" aria-controls="history-drawer">
        <span>Historial reciente</span>
        <span class="history-count" id="history-count">0</span>
      </button>
      <div class="history-extension__card" id="history-drawer">
        <div class="history-panel__header">
          <h3>Tus últimas propiedades</h3>
          <button type="button" id="history-clear" class="history-clear-btn" disabled>Limpiar</button>
        </div>
        <p id="history-empty" class="history-empty">Aún no revisas ninguna propiedad.</p>
        <ul id="history-list" class="history-list"></ul>
      </div>
    </div>

    <script>
      const API_BASE = 'http://localhost:5000/api/yapo-listings';
      const AUTH_BASE = 'http://localhost:5000/api/auth';
      const TOKEN_KEY = 'at_auth_token';
      const EMAIL_KEY = 'at_auth_email';
      const USER_KEY = 'at_auth_user';
      const CLIENT_FILTER_KEYS = ['propertyType', 'location', 'maxPrice', 'bedrooms'];
      const PROPERTY_TYPE_KEYWORDS = {
        casa: ['casa'],
        departamento: ['departamento', 'depto', 'departamento'],
        parcela: ['parcela', 'terreno', 'sitio', 'campo'],
        oficina: ['oficina', 'local', 'comercial'],
        habitacion: ['habitación', 'habitacion', 'pieza'],
        bodega: ['bodega', 'galpón', 'galpon'],
      };
      const UF_TO_CLP_RATE = 37000;
      const HISTORY_STORAGE_KEY = 'at_view_history';
      const HISTORY_MAX_ENTRIES = 30;
      const heroForm = document.getElementById('hero-search-form');
      const sidebarForm = document.getElementById('sidebar-filters-form');
      const statusEl = document.getElementById('status');
      const cardsContainer = document.getElementById('cards');
      const warningsEl = document.getElementById('warnings');
      const overlay = document.getElementById('modal-overlay');
      const loginModal = document.getElementById('login-modal');
      const signupModal = document.getElementById('signup-modal');
      const passwordModal = document.getElementById('password-modal');
      const loginBtn = document.querySelector('[data-action="login"]');
      const signupBtn = document.querySelector('[data-action="signup"]');
      const profileNavBtn = document.querySelector('[data-action="profile-tab"]');
      const forgotPasswordBtn = document.querySelector('[data-open-modal="password"]');
      const authIndicator = document.getElementById('auth-indicator');
      const loginForm = document.getElementById('login-form');
      const signupForm = document.getElementById('signup-form');
      const resetRequestForm = document.getElementById('reset-request-form');
      const resetConfirmForm = document.getElementById('reset-confirm-form');
      const profileForm = document.getElementById('profile-form');
      const profileLockedMessage = document.getElementById('profile-locked');
      const passwordFields = document.getElementById('password-fields');
      const togglePasswordBtn = document.getElementById('toggle-password-fields');
      const profileWindow = document.getElementById('profile-window');
      const pageShell = document.querySelector('.page');
      const backToPropertiesBtn = document.getElementById('back-to-properties');
      const brandHomeBtn = document.getElementById('brand-home');
      const propertyModal = document.getElementById('property-modal');
      const propertyModalOverlay = document.getElementById('property-modal-overlay');
      const propertyModalImage = document.getElementById('property-modal-image');
      const propertyModalTitle = document.getElementById('property-modal-title');
      const propertyModalPrice = document.getElementById('property-modal-price');
      const propertyModalMeta = document.getElementById('property-modal-meta');
      const propertyModalDetails = document.getElementById('property-modal-details');
      const propertyModalDescription = document.getElementById('property-modal-description');
      const propertyModalLink = document.getElementById('property-modal-link');
      const propertyModalClose = document.getElementById('property-modal-close');
      const propertyModalCloseSecondary = document.getElementById('property-modal-close-secondary');
      const toastStack = document.getElementById('toast-stack');
      const paginationToolbar = document.getElementById('pagination-toolbar');
      const paginationSummary = document.getElementById('pagination-summary');
      const paginationControls = document.getElementById('pagination-controls');
      const loadAllPagesBtn = document.getElementById('load-all-pages');
      const historyListEl = document.getElementById('history-list');
      const historyEmptyState = document.getElementById('history-empty');
      const historyClearBtn = document.getElementById('history-clear');
      const historyExtension = document.getElementById('history-extension');
      const historyToggleBtn = document.getElementById('history-toggle');
      const historyDrawer = document.getElementById('history-drawer');
      const historyCountBadge = document.getElementById('history-count');
      const paginationState = {
        currentPage: 1,
        mode: 'single',
        totalPages: 1,
        availablePages: [],
      };
      const TOAST_DURATION = 4000;

      const showToast = (message, variant = 'info', duration = TOAST_DURATION) => {
        if (!toastStack) return;
        const toast = document.createElement('div');
        toast.className = `toast toast--${variant}`;
        toast.textContent = message;
        toastStack.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add('toast--visible'));
        setTimeout(() => {
          toast.classList.remove('toast--visible');
          toast.addEventListener('transitionend', () => toast.remove(), { once: true });
        }, duration);
        setTimeout(() => {
          if (toast.parentElement) {
            toast.remove();
          }
        }, duration + 600);
      };

      const clpFormatter = new Intl.NumberFormat('es-CL', {
        style: 'currency',
        currency: 'CLP',
        maximumFractionDigits: 0,
      });

      const extractUfNumericValue = (priceText) => {
        if (!priceText || !/uf/i.test(priceText)) return null;
        const normalized = priceText
          .toLowerCase()
          .replace(/[^0-9,\.]/g, ' ')
          .replace(/\s+/g, ' ')
          .trim();
        const match = normalized.match(/(\d+(?:[\.,]\d+)?)/);
        if (!match) return null;
        const numeric = match[1].replace(/\./g, '').replace(',', '.');
        const value = Number(numeric);
        return Number.isFinite(value) ? value : null;
      };

      const convertUfToClp = (priceText) => {
        const ufValue = extractUfNumericValue(priceText);
        if (ufValue === null) return null;
        return Math.round(ufValue * UF_TO_CLP_RATE);
      };

      const formatClpValue = (amount) => {
        if (!Number.isFinite(amount)) return '';
        return clpFormatter.format(Math.round(amount));
      };

      const formatPriceWithApproximation = (priceText) => {
        if (!priceText) return '';
        const clpApprox = convertUfToClp(priceText);
        if (!clpApprox) return priceText;
        return `${priceText} (~${formatClpValue(clpApprox)})`;
      };

      const readHistoryStore = () => {
        const raw = localStorage.getItem(HISTORY_STORAGE_KEY);
        if (!raw) return {};
        try {
          const parsed = JSON.parse(raw);
          return parsed && typeof parsed === 'object' ? parsed : {};
        } catch (error) {
          console.warn('Historial corrupto, se reiniciará.', error);
          return {};
        }
      };

      const writeHistoryStore = (store) => {
        localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(store || {}));
      };

      const getActiveHistoryKey = () => {
        const user = getStoredUser();
        if (user?.email) {
          return `user:${user.email.toLowerCase()}`;
        }
        return 'guest';
      };

      const getHistoryEntries = (key = getActiveHistoryKey()) => {
        const store = readHistoryStore();
        const bucket = store[key];
        return Array.isArray(bucket) ? bucket : [];
      };

      const persistHistoryEntries = (entries, key = getActiveHistoryKey()) => {
        const store = readHistoryStore();
        store[key] = entries;
        writeHistoryStore(store);
      };

      const clearHistoryBucket = (key = getActiveHistoryKey(), { silent = false } = {}) => {
        persistHistoryEntries([], key);
        if (!silent) {
          renderHistoryEntries();
        }
      };

      const formatHistoryTimestamp = (timestamp) => {
        if (!timestamp) return '';
        const diffMs = Date.now() - Number(timestamp);
        const minutes = Math.floor(diffMs / 60000);
        if (minutes < 1) return 'Hace instantes';
        if (minutes === 1) return 'Hace 1 minuto';
        if (minutes < 60) return `Hace ${minutes} minutos`;
        const hours = Math.floor(minutes / 60);
        if (hours === 1) return 'Hace 1 hora';
        if (hours < 24) return `Hace ${hours} horas`;
        const days = Math.floor(hours / 24);
        return days === 1 ? 'Hace 1 día' : `Hace ${days} días`;
      };

      const renderHistoryEntries = () => {
        if (!historyListEl || !historyEmptyState) return;
        const entries = getHistoryEntries();
        const recent = entries.slice(0, 8);
        historyListEl.innerHTML = '';
        if (historyCountBadge) {
          historyCountBadge.textContent = String(entries.length);
        }
        if (!recent.length) {
          historyEmptyState.classList.remove('hidden');
          if (historyClearBtn) {
            historyClearBtn.disabled = true;
          }
          return;
        }
        historyEmptyState.classList.add('hidden');
        if (historyClearBtn) {
          historyClearBtn.disabled = false;
        }
        recent.forEach((entry) => {
          const listItem = document.createElement('li');
          listItem.className = 'history-entry';

          const title = document.createElement('p');
          title.className = 'history-entry__title';
          title.textContent = entry.title || 'Propiedad sin título';
          const meta = document.createElement('p');
          meta.className = 'history-entry__meta';
          const priceText = entry.price ? formatPriceWithApproximation(entry.price) : 'Precio no disponible';
          const locationText = entry.location || 'Ubicación no indicada';
          meta.textContent = `${priceText} · ${locationText} · ${formatHistoryTimestamp(entry.createdAt)}`;

          const actions = document.createElement('div');
          actions.className = 'history-entry__actions';
          if (entry.link) {
            const anchor = document.createElement('a');
            anchor.href = entry.link;
            anchor.target = '_blank';
            anchor.rel = 'noopener noreferrer';
            anchor.textContent = 'Ver aviso';
            actions.appendChild(anchor);
          }

          listItem.append(title, meta, actions);
          historyListEl.appendChild(listItem);
        });
      };

      const recordViewedListing = (listing) => {
        if (!listing) return;
        const key = getActiveHistoryKey();
        const entries = getHistoryEntries(key);
        const identifier = String(
          listing.link || `${listing.title ?? ''}-${listing.location ?? ''}-${listing.price ?? ''}`
        ).trim();
        if (!identifier) return;
        const nextEntry = {
          id: identifier,
          title: listing.title || 'Propiedad sin título',
          price: listing.price || '',
          location: listing.location || '',
          link: listing.link || '',
          createdAt: Date.now(),
        };
        const filtered = entries.filter((entry) => entry.id !== identifier);
        filtered.unshift(nextEntry);
        const trimmed = filtered.slice(0, HISTORY_MAX_ENTRIES);
        persistHistoryEntries(trimmed, key);
        renderHistoryEntries();
      };

      const clearHistory = () => {
        clearHistoryBucket(getActiveHistoryKey());
        renderHistoryEntries();
        showToast('Historial limpiado.', 'info');
      };

      const setHistoryDrawerOpen = (shouldOpen) => {
        if (!historyExtension || !historyToggleBtn) return;
        historyExtension.classList.toggle('history-extension--open', Boolean(shouldOpen));
        historyToggleBtn.setAttribute('aria-expanded', shouldOpen ? 'true' : 'false');
      };

      const toPositiveNumber = (value) => {
        const parsed = Number(value);
        return Number.isFinite(parsed) && parsed > 0 ? parsed : null;
      };

      const buildDisplayPages = (pages = []) => {
        const sanitized = pages
          .map((pageNumber) => toPositiveNumber(pageNumber))
          .filter((pageNumber) => pageNumber !== null);
        const sorted = Array.from(new Set(sanitized)).sort((a, b) => a - b);
        if (!sorted.length) return [];
        const sequence = [];
        sorted.forEach((value, index) => {
          if (index > 0 && value - sorted[index - 1] > 1) {
            sequence.push('ellipsis');
          }
          sequence.push(value);
        });
        return sequence;
      };

      const updateLoadAllButtonState = (isActive) => {
        if (!loadAllPagesBtn) return;
        loadAllPagesBtn.classList.toggle('is-active', Boolean(isActive));
        loadAllPagesBtn.textContent = isActive ? 'Mostrando todas las páginas' : 'Cargar todas las páginas';
      };

      const getPagesWithResults = (listings = []) => {
        const pages = new Set();
        listings.forEach((listing) => {
          if (typeof listing.sourcePage === 'number' && Number.isFinite(listing.sourcePage)) {
            pages.add(listing.sourcePage);
          }
        });
        return Array.from(pages).sort((a, b) => a - b);
      };

      const renderPagination = (pagination = {}, meta = {}, filteredPages = []) => {
        if (!paginationToolbar || !paginationSummary || !paginationControls) return;
        if (!pagination) {
          paginationToolbar.classList.add('hidden');
          paginationControls.innerHTML = '';
          paginationSummary.textContent = 'Paginación no disponible.';
          updateLoadAllButtonState(false);
          if (loadAllPagesBtn) {
            loadAllPagesBtn.disabled = true;
          }
          return;
        }
        const multiPageAvailable = Array.isArray(pagination.pages) && pagination.pages.length > 1;
        const multiPageAllowed = meta.multiPageAllowed !== false;
        const filteredPagesSet = new Set(filteredPages.filter((value) => Number.isFinite(value)));
        if (loadAllPagesBtn) {
          loadAllPagesBtn.disabled = !multiPageAllowed;
        }

        if (!multiPageAvailable) {
          paginationToolbar.classList.add('hidden');
          paginationControls.innerHTML = '';
          paginationSummary.textContent = 'Este resultado no ofrece más páginas.';
          updateLoadAllButtonState(false);
          paginationState.availablePages = pagination.pages || [];
          paginationState.totalPages = pagination.totalPages || 1;
          paginationState.mode = 'single';
          return;
        }

        paginationToolbar.classList.remove('hidden');
        paginationState.availablePages = pagination.pages;
        paginationState.totalPages = pagination.totalPages || pagination.pages[pagination.pages.length - 1] || paginationState.totalPages;
        paginationState.currentPage = pagination.currentPage || paginationState.currentPage;
        const totalPages = paginationState.totalPages || pagination.pages[pagination.pages.length - 1] || paginationState.currentPage;

        const fetchedPages = Array.isArray(pagination.fetchedPages) && pagination.fetchedPages.length
          ? pagination.fetchedPages
          : [pagination.currentPage];
        const fetchMode = meta.fetchMode || (fetchedPages.length > 1 ? 'batch' : 'single');
        if (fetchMode !== 'all' || !multiPageAllowed) {
          paginationState.mode = 'single';
          updateLoadAllButtonState(false);
        } else {
          paginationState.mode = 'all';
          updateLoadAllButtonState(true);
        }

        const filteredSuffix =
          filteredPagesSet.size > 0
            ? ` | ${filteredPagesSet.size} página${filteredPagesSet.size === 1 ? '' : 's'} tras los filtros.`
            : ' | Ninguna página coincide con los filtros.';

        paginationSummary.textContent =
          paginationState.mode === 'all'
            ? `Mostrando ${fetchedPages.length} páginas (${fetchedPages.join(', ')}) de ${totalPages}${filteredSuffix}`
            : `Página ${pagination.currentPage} de ${totalPages}${filteredSuffix}`;

        paginationControls.innerHTML = '';
        const prevButton = document.createElement('button');
        prevButton.className = 'pagination-button';
        prevButton.textContent = 'Anterior';
        prevButton.disabled = !pagination.hasPrev || pagination.currentPage <= 1;
        prevButton.addEventListener('click', () => goToPage(Math.max(1, pagination.currentPage - 1)));
        paginationControls.appendChild(prevButton);

        buildDisplayPages(pagination.pages).forEach((token) => {
          if (token === 'ellipsis') {
            const span = document.createElement('span');
            span.className = 'pagination-ellipsis';
            span.textContent = '...';
            paginationControls.appendChild(span);
            return;
          }
          const button = document.createElement('button');
          button.className = 'pagination-button';
          button.textContent = token;
          const hasFilteredResults = filteredPagesSet.has(token);
          button.classList.toggle('no-results', !hasFilteredResults);
          button.title = hasFilteredResults
            ? `Esta página contiene resultados tras los filtros.`
            : 'Esta página no tiene coincidencias con los filtros actuales.';
          if (token === pagination.currentPage) {
            button.classList.add('is-active');
          }
          button.addEventListener('click', () => goToPage(token));
          paginationControls.appendChild(button);
        });

        const nextButton = document.createElement('button');
        nextButton.className = 'pagination-button';
        nextButton.textContent = 'Siguiente';
        nextButton.disabled = !pagination.hasNext || pagination.currentPage >= pagination.totalPages;
        nextButton.addEventListener('click', () => goToPage(pagination.currentPage + 1));
        paginationControls.appendChild(nextButton);
      };

      const initPasswordToggles = () => {
        document.querySelectorAll('.password-field').forEach((field) => {
          const input = field.querySelector('input[type="password"], input[data-password]');
          const toggle = field.querySelector('.password-toggle');
          if (!input || !toggle) return;

          const setVisibility = (shouldShow) => {
            input.type = shouldShow ? 'text' : 'password';
            toggle.classList.toggle('is-active', shouldShow);
            toggle.setAttribute('aria-pressed', String(shouldShow));
            toggle.setAttribute('aria-label', shouldShow ? 'Ocultar contraseña' : 'Mostrar contraseña');
          };

          setVisibility(false);

          toggle.addEventListener('click', () => {
            const isHidden = input.type === 'password';
            setVisibility(isHidden);
          });

          if (input.form) {
            input.form.addEventListener('reset', () => setVisibility(false));
          }
        });
      };

      const DETAIL_ICON_SVGS = {
        area: `
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M7 17L17 7" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M10 7h7v7" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M7 10V3h7" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
        `,
        bed: `
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M3 10h18v6H3z" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M7 10V8a2 2 0 0 1 2-2h3" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M3 16v3" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M21 16v3" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
        `,
        bath: `
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M5 11V6a3 3 0 0 1 6 0v5" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M5 11h14v3a4 4 0 0 1-4 4H9a4 4 0 0 1-4-4z" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M7 18v2" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M17 18v2" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
        `,
        default: `
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <circle cx="12" cy="12" r="4"></circle>
            <path d="M12 4v2"></path>
            <path d="M12 18v2"></path>
            <path d="M4 12h2"></path>
            <path d="M18 12h2"></path>
          </svg>
        `,
      };

      const normalizeDetailLabel = (detail) => {
        if (!detail) return '';
        return detail.replace(/m2/gi, 'm²').trim();
      };

      const detectDetailType = (detail, index) => {
        const normalized = (detail || '').toLowerCase();
        if (normalized.includes('m')) return 'area';
        if (normalized.includes('baño') || normalized.includes('bano')) return 'bath';
        if (normalized.includes('hab') || normalized.includes('dorm')) return 'bed';
        if (index === 0) return 'area';
        if (index === 1) return 'bed';
        if (index === 2) return 'bath';
        return 'default';
      };

      const createDetailNode = (detail, index, variant = 'card') => {
        const li = document.createElement('li');
        li.className = variant === 'modal' ? 'property-modal__detail' : 'card-details__item';
        const iconSpan = document.createElement('span');
        iconSpan.className = variant === 'modal' ? 'property-modal__detail-icon' : 'card-details__icon';
        const iconType = detectDetailType(detail, index);
        iconSpan.innerHTML = DETAIL_ICON_SVGS[iconType] || DETAIL_ICON_SVGS.default;
        const valueSpan = document.createElement('span');
        valueSpan.textContent = normalizeDetailLabel(detail);
        li.append(iconSpan, valueSpan);
        return li;
      };

      const getCombinedFilters = () => {
        const heroData = new FormData(heroForm);
        const sidebarData = new FormData(sidebarForm);
        const params = {};
        
        // Defaults
        params.region = 'maule';
        params.category = 'inmuebles';
        params.limit = 24;
        params.page = 1;

        for (const [key, value] of heroData.entries()) {
          if (value) params[key] = value;
        }
        
        // Handle sidebar data
        // For checkboxes (bedrooms), we need to collect all values
        const bedrooms = [];
        for (const [key, value] of sidebarData.entries()) {
          if (key === 'bedrooms') {
            bedrooms.push(value);
          } else if (value) {
            params[key] = value;
          }
        }
        if (bedrooms.length > 0) {
          params.bedrooms = bedrooms;
        }

        return params;
      };

      const separateFilters = (params = {}) => {
        const server = {};
        const client = {};
        Object.entries(params).forEach(([key, value]) => {
          if (CLIENT_FILTER_KEYS.includes(key)) {
            client[key] = value;
          } else {
            server[key] = value;
          }
        });
        return { server, client };
      };

      const normalizeClientFilters = (filters = {}) => {
        const toNumber = (raw) => {
          if (raw === null || typeof raw === 'undefined') return null;
          if (typeof raw === 'string' && !raw.trim()) return null;
          const parsed = Number(raw);
          return Number.isFinite(parsed) && parsed >= 0 ? parsed : null;
        };

        const normalized = {
          propertyType: (filters.propertyType || '').toLowerCase(),
          location: (filters.location || '').toLowerCase(),
          maxPrice: toNumber(filters.maxPrice),
          bedrooms: Array.isArray(filters.bedrooms) ? filters.bedrooms : [],
        };
        
        normalized.hasActiveFilters = Boolean(
          normalized.propertyType ||
            normalized.location ||
            normalized.maxPrice !== null ||
            normalized.bedrooms.length > 0
        );
        return normalized;
      };

      const parsePriceToNumber = (priceText) => {
        if (!priceText) return null;
        const clpFromUf = convertUfToClp(priceText);
        if (clpFromUf !== null) {
          return clpFromUf;
        }
        const digits = priceText.replace(/[^0-9]/g, '');
        if (!digits) return null;
        const value = Number(digits);
        return Number.isFinite(value) ? value : null;
      };

      const matchesPropertyType = (listing, propertyType) => {
        if (!propertyType) return true;
        const keywords = PROPERTY_TYPE_KEYWORDS[propertyType];
        if (!keywords || !keywords.length) return true;
        const haystack = `${listing.title || ''} ${listing.description || ''}`.toLowerCase();
        return keywords.some((keyword) => haystack.includes(keyword));
      };

      const matchesLocation = (listingLocation, locationFilter) => {
        if (!locationFilter) return true;
        return (listingLocation || '').toLowerCase().includes(locationFilter);
      };

      const matchesPriceRange = (priceNumber, maxPrice) => {
        if (maxPrice !== null && (priceNumber === null || priceNumber > maxPrice)) return false;
        return true;
      };

      const matchesBedrooms = (listing, selectedBedrooms) => {
        if (!selectedBedrooms || selectedBedrooms.length === 0) return true;
        
        // Try to extract bedrooms from title or description
        // Patterns: "2 dorm", "3 habitaciones", "1 pieza"
        const text = `${listing.title || ''} ${listing.description || ''}`.toLowerCase();
        const match = text.match(/(\d+)\s*(dorm|habitaci|pieza)/);
        
        if (!match) return false; // If we can't find info, maybe exclude or include? Let's exclude to be strict.
        
        const count = parseInt(match[1]);
        
        return selectedBedrooms.some(val => {
          if (val === '4+') return count >= 4;
          return count === parseInt(val);
        });
      };

      const applyClientFilters = (listings = [], filters = {}) => {
        const normalized = normalizeClientFilters(filters);
        const filtered = listings.filter((listing) => {
          const priceNumber = parsePriceToNumber(listing.price);
          const typeMatch = matchesPropertyType(listing, normalized.propertyType);
          const locationMatch = matchesLocation(listing.location, normalized.location);
          const priceMatch = matchesPriceRange(priceNumber, normalized.maxPrice);
          const bedroomMatch = matchesBedrooms(listing, normalized.bedrooms);
          return typeMatch && locationMatch && priceMatch && bedroomMatch;
        });
        return { filtered, normalized };
      };

      const renderWarnings = (warnings = []) => {
        warningsEl.innerHTML = '';
        warnings.forEach((warning) => {
          const li = document.createElement('li');
          li.textContent = warning;
          warningsEl.appendChild(li);
        });
      };

      const renderListings = (listings) => {
        cardsContainer.innerHTML = '';
        if (!listings || listings.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'empty-state';
          empty.textContent = 'No se encontraron resultados para los filtros seleccionados.';
          cardsContainer.appendChild(empty);
          return;
        }

        listings.forEach((item) => {
          const card = document.createElement('article');
          card.className = 'card';

          if (item.image) {
            const img = document.createElement('img');
            img.src = item.image;
            img.alt = item.title || 'Imagen del aviso';
            card.appendChild(img);
          }

          const body = document.createElement('div');
          body.className = 'card-body';

          const title = document.createElement('h3');
          title.textContent = item.title || 'Aviso sin título';
          body.appendChild(title);

          if (item.price) {
            const price = document.createElement('p');
            price.className = 'price';
            price.textContent = formatPriceWithApproximation(item.price);
            body.appendChild(price);
          }

          if (item.location || item.seller) {
            const meta = document.createElement('p');
            meta.className = 'meta';
            meta.textContent = [item.location, item.seller].filter(Boolean).join(' · ');
            body.appendChild(meta);
          }

          if (typeof item.sourcePage === 'number') {
            const pageBadge = document.createElement('span');
            pageBadge.className = 'card-page-badge';
            pageBadge.textContent = `Página ${item.sourcePage}`;
            body.appendChild(pageBadge);
          }

          if (Array.isArray(item.details) && item.details.length) {
            const detailList = document.createElement('ul');
            detailList.className = 'card-details';
            item.details.slice(0, 3).forEach((detail, index) => {
              detailList.appendChild(createDetailNode(detail, index));
            });
            body.appendChild(detailList);
          }

          if (item.description) {
            const desc = document.createElement('p');
            desc.textContent = item.description;
            body.appendChild(desc);
          }

          if (item.link) {
            const anchor = document.createElement('a');
            anchor.href = item.link;
            anchor.target = '_blank';
            anchor.rel = 'noopener noreferrer';
            anchor.textContent = 'Ver aviso';
            body.appendChild(anchor);
          }

          card.appendChild(body);
          card.classList.add('card--interactive');
          card.addEventListener('click', (event) => {
            if (event.target.closest('a')) {
              return;
            }
            openPropertyModal(item);
          });
          cardsContainer.appendChild(card);
        });
      };

      const fetchListings = async (serverParams = {}, clientFilters = {}) => {
        const url = new URL(API_BASE);
        Object.entries(serverParams).forEach(([key, value]) => url.searchParams.set(key, value));

        statusEl.textContent = 'Actualizando resultados...';
        statusEl.style.color = '#38bdf8';

        try {
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`Error ${response.status}: ${response.statusText}`);
          }
          const payload = await response.json();
          const meta = payload.meta || {};
          const { filtered, normalized } = applyClientFilters(payload.listings || [], clientFilters);
          const total = meta.total ?? payload.listings?.length ?? 0;
          const filteredCount = filtered.length;
          const pagesFetchedCount = Array.isArray(meta.pagesFetched) ? meta.pagesFetched.length : 1;
          const filteredPages = getPagesWithResults(filtered);
          const paginationDescriptor = (() => {
            if (meta.fetchMode === 'all') {
              return ` abarcando ${pagesFetchedCount} páginas${meta.totalPages ? ` (total ${meta.totalPages})` : ''}`;
            }
            if (meta.totalPages) {
              const current = meta.page || payload.pagination?.currentPage || paginationState.currentPage;
              return ` (página ${current} de ${meta.totalPages})`;
            }
            return '';
          })();
          const baseMessage = `Recibidos ${total} avisos${paginationDescriptor}`;
          statusEl.textContent = normalized.hasActiveFilters
            ? `${baseMessage} (mostrando ${filteredCount} tras los filtros locales).`
            : `${baseMessage} (mostrando ${filteredCount}).`;
          statusEl.style.color = '#22c55e';
          renderWarnings(payload.warnings || []);
          renderListings(filtered);
          renderPagination(payload.pagination || {}, meta, filteredPages);
        } catch (error) {
          console.error(error);
          statusEl.textContent = `Error consultando el backend: ${error.message}`;
          statusEl.style.color = '#f87171';
          renderListings([]);
          renderPagination(null, {}, []);
        }
      };

      const handleSearch = ({ resetPage = false } = {}) => {
        if (resetPage) {
          paginationState.currentPage = 1;
        }
        const params = getCombinedFilters();
        const { server, client } = separateFilters(params);
        server.page = paginationState.currentPage;
        if (paginationState.mode === 'all') {
          server.pages = 'all';
        }
        fetchListings(server, client);
      };

      heroForm.addEventListener('submit', (event) => {
        event.preventDefault();
        paginationState.mode = 'single';
        updateLoadAllButtonState(false);
        handleSearch({ resetPage: true });
      });

      sidebarForm.addEventListener('submit', (event) => {
        event.preventDefault();
        paginationState.mode = 'single';
        updateLoadAllButtonState(false);
        handleSearch({ resetPage: true });
      });

      const setFeedback = (type, message, variant = 'error') => {
        const el = document.querySelector(`[data-feedback="${type}"]`);
        if (!el) return;
        if (!message) {
          el.style.display = 'none';
          el.textContent = '';
          el.classList.remove('success', 'error');
          return;
        }
        el.textContent = message;
        el.style.display = 'block';
        el.classList.remove('success', 'error');
        if (variant === 'success') el.classList.add('success');
        if (variant === 'error') el.classList.add('error');
      };

      const toggleModal = (modal, show) => {
        if (!modal) return;
        if (show) {
          modal.classList.add('show');
          overlay.classList.add('show');
        } else {
          modal.classList.remove('show');
          overlay.classList.remove('show');
          modal.querySelectorAll('.form-feedback').forEach((el) => {
            const type = el.getAttribute('data-feedback');
            if (type) setFeedback(type, '');
          });
          modal.querySelectorAll('form').forEach((formEl) => formEl.reset());
        }
      };

      const getStoredUser = () => {
        const raw = localStorage.getItem(USER_KEY);
        if (!raw) return null;
        try {
          return JSON.parse(raw);
        } catch (error) {
          console.warn('No se pudo leer el usuario almacenado', error);
          return null;
        }
      };

      const setStoredUser = (user) => {
        if (!user) {
          localStorage.removeItem(USER_KEY);
          localStorage.removeItem(EMAIL_KEY);
          return;
        }
        localStorage.setItem(USER_KEY, JSON.stringify(user));
        if (user.email) {
          localStorage.setItem(EMAIL_KEY, user.email);
        }
      };

      const authHeaders = () => {
        const token = localStorage.getItem(TOKEN_KEY);
        return token ? { Authorization: `Bearer ${token}` } : {};
      };

      const isAuthenticated = () => Boolean(localStorage.getItem(TOKEN_KEY));

      const resetPasswordInputs = () => {
        if (!profileForm) return;
        if (profileForm.elements.password) profileForm.elements.password.value = '';
        if (profileForm.elements.confirmPassword) profileForm.elements.confirmPassword.value = '';
        if (passwordFields) passwordFields.classList.remove('show');
        if (togglePasswordBtn) togglePasswordBtn.textContent = 'Cambiar contraseña';
      };

      const populateProfileForm = (user) => {
        if (!profileForm || !user) return;
        if (profileForm.elements.name) profileForm.elements.name.value = user.name || '';
        if (profileForm.elements.email) profileForm.elements.email.value = user.email || '';
        resetPasswordInputs();
      };

      const cleanTextBlock = (text) =>
        (text || '')
          .replace(/\r\n|\r|\n/g, '\n')
          .replace(/\n{3,}/g, '\n\n')
          .trim();

      const openPropertyModal = (listing) => {
        if (!propertyModal || !propertyModalOverlay) return;
        const imageSrc = listing.image || '';
        if (propertyModalImage) {
          if (imageSrc) {
            propertyModalImage.src = imageSrc;
            propertyModalImage.alt = listing.title || 'Imagen de la propiedad';
            propertyModalImage.style.display = '';
          } else {
            propertyModalImage.removeAttribute('src');
            propertyModalImage.alt = '';
            propertyModalImage.style.display = 'none';
          }
        }
        if (propertyModalTitle) propertyModalTitle.textContent = listing.title || 'Propiedad sin título';
        if (propertyModalPrice) propertyModalPrice.textContent = formatPriceWithApproximation(listing.price || '');
        const metaParts = [listing.location, listing.seller].filter(Boolean);
        if (typeof listing.sourcePage === 'number') {
          metaParts.push(`Página ${listing.sourcePage}`);
        }
        if (propertyModalMeta) propertyModalMeta.textContent = metaParts.join(' · ');

        if (propertyModalDetails) {
          propertyModalDetails.innerHTML = '';
          (listing.details || []).forEach((detail, index) => {
            propertyModalDetails.appendChild(createDetailNode(detail, index, 'modal'));
          });
          propertyModalDetails.style.display = listing.details?.length ? 'flex' : 'none';
        }

        if (propertyModalDescription) {
          const normalizedDescription = listing.description || '';
          propertyModalDescription.textContent = cleanTextBlock(normalizedDescription) || 'Sin descripción adicional.';
        }

        if (propertyModalLink) {
          if (listing.link) {
            propertyModalLink.href = listing.link;
            propertyModalLink.style.display = '';
          } else {
            propertyModalLink.href = '#';
            propertyModalLink.style.display = 'none';
          }
        }

        recordViewedListing(listing);
        propertyModalOverlay.classList.add('show');
        propertyModal.classList.add('show');
        document.body.classList.add('no-scroll');
      };

      const closePropertyModal = () => {
        propertyModalOverlay?.classList.remove('show');
        propertyModal?.classList.remove('show');
        document.body.classList.remove('no-scroll');
      };

      const enterProfileView = () => {
        if (!pageShell) return;
        pageShell.classList.add('profile-view');
        if (profileWindow) {
          profileWindow.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      };

      const exitProfileView = () => {
        if (!pageShell) return;
        pageShell.classList.remove('profile-view');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };

      const refreshProfileData = async (options = {}) => {
        if (!isAuthenticated()) return null;
        try {
          const response = await fetch(`${AUTH_BASE}/me`, {
            headers: {
              'Content-Type': 'application/json',
              ...authHeaders(),
            },
          });
          if (!response.ok) {
            if (response.status === 401) {
              localStorage.removeItem(TOKEN_KEY);
              setStoredUser(null);
              updateAuthUI();
            }
            throw new Error('No se pudo obtener la información del perfil.');
          }
          const payload = await response.json();
          if (payload.user) {
            setStoredUser(payload.user);
            populateProfileForm(payload.user);
          }
          if (!options.silent) {
            setFeedback('profile', '', 'success');
          }
          updateAuthUI();
          return payload.user;
        } catch (error) {
          if (!options.silent) {
            setFeedback('profile', error.message, 'error');
          }
          return null;
        }
      };

      const updateAuthUI = () => {
        const storedUser = getStoredUser();
        if (isAuthenticated()) {
          const displayName = storedUser?.name?.trim();
          const email = storedUser?.email || localStorage.getItem(EMAIL_KEY) || 'Usuario autenticado';
          authIndicator.textContent = displayName ? `${displayName} (${email})` : email;
          loginBtn.textContent = 'Cerrar sesión';
          signupBtn.style.display = 'none';
          if (profileNavBtn) profileNavBtn.style.display = '';
          if (profileForm) profileForm.classList.remove('hidden');
          if (profileLockedMessage) profileLockedMessage.classList.add('hidden');
          if (storedUser) populateProfileForm(storedUser);
        } else {
          authIndicator.textContent = 'Visitante';
          loginBtn.textContent = 'Iniciar Sesión';
          signupBtn.style.display = '';
          if (profileNavBtn) profileNavBtn.style.display = 'none';
          if (profileForm) {
            profileForm.reset();
            profileForm.classList.add('hidden');
          }
          resetPasswordInputs();
          if (profileLockedMessage) profileLockedMessage.classList.remove('hidden');
          exitProfileView();
          setFeedback('profile', '', 'success');
        }
        renderHistoryEntries();
      };

      loginBtn.addEventListener('click', () => {
        if (isAuthenticated()) {
          localStorage.removeItem(TOKEN_KEY);
          setStoredUser(null);
          updateAuthUI();
          showToast('Sesión cerrada correctamente.', 'info');
          return;
        }
        toggleModal(loginModal, true);
      });

      signupBtn.addEventListener('click', () => toggleModal(signupModal, true));
      if (profileNavBtn) {
        profileNavBtn.addEventListener('click', () => {
          if (!isAuthenticated()) {
            showToast('Inicia sesión para administrar tu perfil.', 'warning');
            exitProfileView();
            return;
          }
          enterProfileView();
          refreshProfileData({ silent: true });
        });
      }

      if (backToPropertiesBtn) {
        backToPropertiesBtn.addEventListener('click', () => {
          exitProfileView();
        });
      }

      if (brandHomeBtn) {
        brandHomeBtn.addEventListener('click', () => {
          exitProfileView();
        });
      }

      if (historyClearBtn) {
        historyClearBtn.addEventListener('click', clearHistory);
      }

      if (historyToggleBtn) {
        historyToggleBtn.addEventListener('click', () => {
          const isOpen = historyExtension?.classList.contains('history-extension--open');
          setHistoryDrawerOpen(!isOpen);
        });
      }

      if (loadAllPagesBtn) {
        loadAllPagesBtn.addEventListener('click', () => {
          if (loadAllPagesBtn.disabled) {
            showToast('No se puede cargar todas las páginas con la URL actual.', 'warning');
            return;
          }
          const enteringAllMode = paginationState.mode !== 'all';
          paginationState.mode = enteringAllMode ? 'all' : 'single';
          paginationState.currentPage = 1;
          updateLoadAllButtonState(enteringAllMode);
          handleSearch({ resetPage: true });
        });
      }

      function goToPage(pageNumber) {
        const sanitized = toPositiveNumber(pageNumber);
        if (!sanitized) return;
        const isSamePage = sanitized === paginationState.currentPage;
        const wasAllMode = paginationState.mode === 'all';
        paginationState.mode = 'single';
        updateLoadAllButtonState(false);
        if (isSamePage && !wasAllMode) return;
        paginationState.currentPage = sanitized;
        handleSearch();
      }

      propertyModalOverlay?.addEventListener('click', closePropertyModal);
      propertyModal?.addEventListener('click', (event) => {
        if (!event.target.closest('.property-modal__panel')) {
          closePropertyModal();
        }
      });
      propertyModalClose?.addEventListener('click', closePropertyModal);
      propertyModalCloseSecondary?.addEventListener('click', closePropertyModal);
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && propertyModal?.classList.contains('show')) {
          closePropertyModal();
        }
      });
      overlay.addEventListener('click', () => {
        toggleModal(loginModal, false);
        toggleModal(signupModal, false);
        toggleModal(passwordModal, false);
      });
      document.querySelectorAll('[data-close-modal]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const target = btn.getAttribute('data-close-modal');
          if (target === 'login') toggleModal(loginModal, false);
          if (target === 'signup') toggleModal(signupModal, false);
          if (target === 'password') toggleModal(passwordModal, false);
        });
      });

      if (forgotPasswordBtn) {
        forgotPasswordBtn.addEventListener('click', () => toggleModal(passwordModal, true));
      }

      loginForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        setFeedback('login', 'Verificando credenciales...', 'success');
        const data = Object.fromEntries(new FormData(loginForm).entries());
        try {
          const response = await fetch(`${AUTH_BASE}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });
          const payload = await response.json();
          if (!response.ok) {
            throw new Error(payload.message || 'No se pudo iniciar sesión');
          }
          localStorage.setItem(TOKEN_KEY, payload.token);
          if (payload.user) {
            setStoredUser(payload.user);
          } else {
            setStoredUser({ email: data.email });
          }
          clearHistoryBucket(getActiveHistoryKey(), { silent: true });
          setFeedback('login', 'Inicio de sesión exitoso.', 'success');
          toggleModal(loginModal, false);
          updateAuthUI();
          showToast('Sesión iniciada. Puedes acceder a rutas protegidas.', 'success');
        } catch (error) {
          setFeedback('login', error.message, 'error');
        }
      });

      signupForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        setFeedback('signup', 'Creando cuenta...', 'success');
        const data = Object.fromEntries(new FormData(signupForm).entries());
        try {
          const response = await fetch(`${AUTH_BASE}/signup`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });
          const payload = await response.json();
          if (!response.ok) {
            throw new Error(payload.message || 'No se pudo registrar');
          }
          setFeedback('signup', 'Cuenta creada. Ahora inicia sesión.', 'success');
          signupForm.reset();
        } catch (error) {
          setFeedback('signup', error.message, 'error');
        }
      });

      if (resetRequestForm) {
        resetRequestForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          setFeedback('reset-request', 'Generando token de recuperación...', 'success');
          const data = Object.fromEntries(new FormData(resetRequestForm).entries());
          try {
            const response = await fetch(`${AUTH_BASE}/forgot-password`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data),
            });
            const payload = await response.json();
            if (!response.ok) {
              throw new Error(payload.message || 'No se pudo generar el token');
            }
            let message = payload.message || 'Solicitud enviada. Revisa tu correo.';
            if (payload.token) {
              message += ` Token temporal: ${payload.token}`;
            }
            setFeedback('reset-request', message, 'success');
            resetRequestForm.reset();
          } catch (error) {
            setFeedback('reset-request', error.message, 'error');
          }
        });
      }

      if (resetConfirmForm) {
        resetConfirmForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          const dataEntries = Object.fromEntries(new FormData(resetConfirmForm).entries());
          if (dataEntries.password !== dataEntries.confirmPassword) {
            setFeedback('reset-confirm', 'Las contraseñas no coinciden.', 'error');
            return;
          }
          setFeedback('reset-confirm', 'Actualizando contraseña...', 'success');
          try {
            const response = await fetch(`${AUTH_BASE}/reset-password`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ token: dataEntries.token, password: dataEntries.password }),
            });
            const payload = await response.json();
            if (!response.ok) {
              throw new Error(payload.message || 'No se pudo actualizar la contraseña');
            }
            setFeedback('reset-confirm', payload.message || 'Contraseña actualizada.', 'success');
            resetConfirmForm.reset();
            setTimeout(() => toggleModal(passwordModal, false), 1500);
          } catch (error) {
            setFeedback('reset-confirm', error.message, 'error');
          }
        });
      }

      if (togglePasswordBtn && passwordFields) {
        togglePasswordBtn.addEventListener('click', () => {
          if (!isAuthenticated()) {
            showToast('Inicia sesión para definir una nueva contraseña.', 'warning');
            return;
          }
          const showing = passwordFields.classList.toggle('show');
          togglePasswordBtn.textContent = showing ? 'Ocultar cambio de contraseña' : 'Cambiar contraseña';
          if (!showing) {
            if (profileForm?.elements.password) profileForm.elements.password.value = '';
            if (profileForm?.elements.confirmPassword) profileForm.elements.confirmPassword.value = '';
          }
        });
      }

      if (profileForm) {
        profileForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (!isAuthenticated()) {
            setFeedback('profile', 'Debes iniciar sesión para actualizar tu perfil.', 'error');
            return;
          }
          const formEntries = Object.fromEntries(new FormData(profileForm).entries());
          const currentUser = getStoredUser();
          const updates = {};
          const trimmedName = (formEntries.name || '').trim();
          if (currentUser?.name !== trimmedName) {
            updates.name = trimmedName || null;
          }
          if (formEntries.email && formEntries.email !== currentUser?.email) {
            updates.email = formEntries.email;
          }
          if (formEntries.password || formEntries.confirmPassword) {
            if (formEntries.password !== formEntries.confirmPassword) {
              setFeedback('profile', 'Las contraseñas no coinciden.', 'error');
              return;
            }
            updates.password = formEntries.password;
          }
          if (!Object.keys(updates).length) {
            setFeedback('profile', 'No detectamos cambios para guardar.', 'error');
            return;
          }
          setFeedback('profile', 'Guardando cambios...', 'success');
          try {
            const response = await fetch(`${AUTH_BASE}/me`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
                ...authHeaders(),
              },
              body: JSON.stringify(updates),
            });
            const payload = await response.json();
            if (!response.ok) {
              if (response.status === 401) {
                localStorage.removeItem(TOKEN_KEY);
                setStoredUser(null);
                updateAuthUI();
              }
              throw new Error(payload.message || 'No se pudo actualizar el perfil.');
            }
            if (payload.user) {
              setStoredUser(payload.user);
              populateProfileForm(payload.user);
            }
            setFeedback('profile', payload.message || 'Perfil actualizado correctamente.', 'success');
            resetPasswordInputs();
            updateAuthUI();
          } catch (error) {
            setFeedback('profile', error.message, 'error');
          }
        });
      }

      initPasswordToggles();
      updateAuthUI();
      if (isAuthenticated()) {
        refreshProfileData({ silent: true });
      }

      // Sidebar Slider Logic
      const sidebarSlider = document.getElementById('sidebar-price-slider');
      const sidebarPriceDisplay = document.getElementById('sidebar-price-display');

      const formatPrice = (val) => {
        return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 }).format(val);
      };

      if (sidebarSlider && sidebarPriceDisplay) {
        sidebarSlider.addEventListener('input', (e) => {
          const val = parseInt(e.target.value);
          sidebarPriceDisplay.textContent = formatPrice(val);
        });
      }

      // Carga inicial
      handleSearch({ resetPage: true });
    </script>
  </body>
</html>
